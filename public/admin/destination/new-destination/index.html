<!DOCTYPE html>
<html lang="en">

<head>
  <base href="./">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <meta name="description" content="CoreUI - Open Source Bootstrap Admin Template">
  <meta name="author" content="Łukasz Holeczek">
  <meta name="keyword" content="Bootstrap,Admin,Template,Open,Source,jQuery,CSS,HTML,RWD,Dashboard">
  <title>New destination</title>
  <link rel="apple-touch-icon" sizes="57x57" href="../../assets/favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="../../assets/favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="../../assets/favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="../../assets/favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="../../assets/favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="../../assets/favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="../../assets/favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="../../assets/favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../../assets/favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="../../assets/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../../assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="../../assets/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../assets/favicon/favicon-16x16.png">
  <link rel="manifest" href="../../assets/favicon/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="../../assets/favicon/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <!-- Main styles for this application-->
  <link href="../../css/style.css" rel="stylesheet">
  <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>
</head>

<body>
  <!-- Main -->
  <div class="wrapper d-flex flex-column min-vh-100 bg-light">
    <!-- a button to navigate back to previos page -->

    <div class="container-lg mb-4 mt-4">
      <button class="btn btn-primary btn-sm" onclick="window.location.href = '/admin/destination'" role="tab">
        <svg class="icon me-2">
          <use xlink:href="../../vendors/@coreui/icons/svg/free.svg#cil-chevron-left"></use>
        </svg>
        <span>Destinations</span>
      </button>
      
    </div>
    <!-- Body  -->
    <!-- add a form with a submit button -->

    <div class="body flex-grow-1 px-3">
      <div class="container-lg">
        <form>
          <div class="car"></div>
          <div class="card mb-4">
            <div class="card-header">
              <strong>Setup destination</strong>
            </div>

            <div class="card-body">
              <div class="example">
                <div class="row g-3 pt-1">
                  <div class="col-sm-5">
                    <input type="text" class="form-control" placeholder="Destination name"
                      aria-label="Destination name">
                  </div>
                  <div class="form-check form-switch col-sm-2">
                    <input class="form-check-input btn-danger" type="checkbox" role="switch" id="flexSwitchCheckChecked"
                      checked>
                    <label class="form-check-label" for="flexSwitchCheckChecked">Active</label>
                  </div>
                  <div class="col-sm-5">
                    <input class="form-control" type="file" id="formFile" onchange="uploadFile()">
                  </div>
                </div>
                <div class="col-sm-12 pt-3">
                  <textarea rows="5" cols="50" class="form-control" placeholder="Description"
                    aria-label="Description"></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="car"></div>
          <div class="card mb-4">
            <div class="card-header">
              <strong>Destination content</strong>
            </div>

            <div class="card-body">
              <div class="example">
                <div class="col-sm-12 pt-1">
                  <textarea id="editor" rows="10" cols="50" class="form-control" placeholder="Content"
                    aria-label="Content"></textarea>
                </div>
                <div class="col-sm-5 pt-3">
                  <input class="form-control" type="file" id="formMultiFile" onchange="uploadMutilFile()" multiple>
                </div>
                <div class="row row-cols-1 row-cols-md-5 g-4 pt-3" id="img-row">
                  <!-- Image generate here -->
                </div>

                <div class="hotels pt-4">
                  <div class="row">
                    <div class="col-sm-12">
                      <h6>Recommended Hotel:</h6>
                    </div>
                    <div class="row hotel-list" id="hotel-list">
                      <!-- List hotel here -->
                    </div>
                  </div>
                  <div class="col-sm-2 pt-1">
                    <button type="button" class="btn btn-outline-secondary btn-sm" role="tab"
                      onclick="addHotelSection(hotelSection)">
                      <svg class="icon">
                        <use xlink:href="../../vendors/@coreui/icons/svg/free.svg#cil-plus"></use>
                      </svg>
                      <span>Add hotel</span>
                    </button>
                  </div>
                </div>

                <div class="hotels pt-4">
                  <div class="row">
                    <div class="col-sm-12">
                      <h6>Recommended restaurants:</h6>
                    </div>
                    <div class="row restaurant-list" id="restaurant-list">
                      <!-- List restaurant here -->
                    </div>
                  </div>
                  <div class="col-sm-2 pt-1">
                    <button type="button" class="btn btn-outline-secondary btn-sm" role="tab"
                      onclick="addRestaurantSection(restaurantSection)">
                      <svg class="icon">
                        <use xlink:href="../../vendors/@coreui/icons/svg/free.svg#cil-plus"></use>
                      </svg>
                      <span>Add restaurant</span>
                    </button>
                  </div>
                </div>
                <!-- add simiar section for Tourist Attractions -->
                <div class="tourist-attractions pt-4">
                  <div class="row">
                    <div class="col-sm-12">
                      <h6>Tourist Attractions:</h6>
                    </div>
                    <div class="row tourist-attractions-list" id="tourist-attractions-list">
                      <!-- List tourist attractions here -->
                    </div>
                  </div>
                  <div class="col-sm-2 pt-1">
                    <button type="button" class="btn btn-outline-secondary btn-sm" role="tab"
                      onclick="addTouristAttractionsSection(touristAttractionsSection)">
                      <svg class="icon">
                        <use xlink:href="../../vendors/@coreui/icons/svg/free.svg#cil-plus"></use>
                      </svg>
                      <span>Add tourist attractions</span>
                    </button>
                  </div>

                </div>
              </div>
            </div>

            <div class="col-12 pb-3">
              <button type="button" onclick="addNewDestination()" class="btn btn-primary"
                onclick="addNewDestination()">Submit</button>
            </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="staticBackdropLive" data-coreui-backdrop="static" data-coreui-keyboard="false"
    tabindex="-1" aria-labelledby="staticBackdropLiveLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLiveLabel">New destination added</h5>
          <button class="btn-close" type="button" data-coreui-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Destination has been added successfully</p>
        </div>
        <div class="modal-footer">
          <!-- button to open detail page with id -->
          <button class="btn btn-primary" type="button" id="goto-detail"> Goto detail</button>
        </div>
      </div>
    </div>
  </div>
  <button class="btn btn-primary" id="success-modal" hidden="hidden" type="button" data-coreui-toggle="modal"
    data-coreui-target="#staticBackdropLive"></button>

  <!-- CoreUI and necessary plugins-->
  <script src="../../vendors/@coreui/coreui/js/coreui.bundle.min.js"></script>
  <script src="../../vendors/simplebar/js/simplebar.min.js"></script>
  <!-- Plugins and scripts required by this view-->
  <script src="../../vendors/chart.js/js/chart.min.js"></script>
  <script src="../../vendors/@coreui/chartjs/js/coreui-chartjs.js"></script>
  <script src="../../vendors/@coreui/utils/js/coreui-utils.js"></script>
  <script src="js/main.js"></script>
  <script src="../../../variables.js"></script>
  <script>
    // define model to create new destination
    const newDestination = {
      Name: '',
      IsActive: true,
      Content: '',
      Links: '',
      Description: '',
      Avatar: '',
      Hotels: '',
      Restaurants: '',
      Others: ''
    };
    //global vars
    var CKEditorArray = [];//CKEditor access array

    ClassicEditor
      .create(document.querySelector('#editor'), {
        removePlugins: ['CKFinderUploadAdapter', 'CKFinder', 'EasyImage', 'Image', 'ImageCaption', 'ImageStyle', 'ImageToolbar', 'ImageUpload', 'MediaEmbed'],
        height: 800
      }).then(editor => {
        CKEditorArray['#editor'] = editor;
      })
      .catch(error => {
        console.error(error);
      });

    // define number of hotel section
    let hotelSection = 1;
    let restaurantSection = 1;
    let touristAttractionsSection = 1;

    // upload file
    function uploadFile() {
      const file = document.getElementById('formFile').files[0];
      const formData = new FormData();
      formData.append('file', file);
      fetch(apiUpload, {
        method: 'POST',
        body: formData,
      })
        .then(response => response.json())
        .then(data => {
          newDestination.Avatar = data.url;
          console.log('Success:', data);
        })
        .catch((error) => {
          console.error('Error:', error);
        });
    }

    // Create new destination from form value
    function addNewDestination() {
      const form = document.querySelector('form');

      newDestination.Name = form[0].value;
      newDestination.IsActive = form[1].checked;
      newDestination.Description = form[3].value;
      // get data from ckeditor
      newDestination.Content = CKEditorArray['#editor'].getData();

      // get Hotels from form and convert to json string with keys are description, links
      const hotels = [];
      const hotelList = document.getElementById('hotel-list');

      for (let i = 0; i < hotelList.children.length; i++) {
        const hotel = {
          Description: CKEditorArray[`#editor-${i + 1}`].getData(),
          Links: ""
        };
        var hotelListImg = document.getElementById(`hotel-list-img-${i + 1}`);
        var images = hotelListImg.querySelectorAll('img');
        images.forEach(function (img) {
          hotel.Links += img.getAttribute('src') + ";";
        });

        hotels.push(hotel);
      }
      newDestination.Hotels = JSON.stringify(hotels);

      // get restaurant from form and convert to json string with keys are description, links
      const restaurants = [];
      const restaurantList = document.getElementById('restaurant-list');
      for (let i = 0; i < restaurantList.children.length; i++) {
        const restaurant = {
          Description: CKEditorArray[`#editor-res-${i + 1}`].getData(),
          Links: ""
        };
        var restaurantListImg = document.getElementById(`restaurant-list-img-${i + 1}`);
        var images = restaurantListImg.querySelectorAll('img');
        images.forEach(function (img) {
          restaurant.Links += img.getAttribute('src') + ";";
        });

        restaurants.push(restaurant);
      }
      newDestination.Restaurants = JSON.stringify(restaurants);
      // get tourist attractions from form and convert to json string with keys are description, links
      const touristAttractions = [];
      const touristAttractionsList = document.getElementById('tourist-attractions-list');
      for (let i = 0; i < touristAttractionsList.children.length; i++) {
        const touristAttraction = {
          Description: CKEditorArray[`#editor-tourist-attractions-${i + 1}`].getData(),
          Links: ""
        };
        var touristAttractionsListImg = document.getElementById(`tourist-attractions-list-img-${i + 1}`);
        var images = touristAttractionsListImg.querySelectorAll('img');
        images.forEach(function (img) {
          touristAttraction.Links += img.getAttribute('src') + ";";
        });

        touristAttractions.push(touristAttraction);
      }
      newDestination.Others = JSON.stringify(touristAttractions);

      console.log(newDestination);
      fetch(apiDestinations, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(newDestination),
      })
        .then(response => response.json())
        .then(data => {
          console.log('Success:', data);
          // show a dialog to confirm the success; then redirect to the destination page
          document.getElementById('success-modal').click();

          // update goto detail button with new id href
          document.getElementById('goto-detail').addEventListener('click', () => {
            window.location.href = `/admin/destination/detail-destination?id=${data.id}`;
          });
        })
        .catch((error) => {
          console.error('Error:', error);
        });

    };

    // upload mutil file
    function uploadMutilFile() {
      // clear old files
      newDestination.Links = '';

      const files = document.getElementById('formMultiFile').files;
      const formData = new FormData();
      for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
      }
      fetch(apiUpload + '/multi', {
        method: 'POST',
        body: formData,
      })
        .then(response => response.json())
        .then(data => {

          console.log('Success:', data);
          const cardRow = document.getElementById('img-row');
          // clear old data
          cardRow.innerHTML = '';
          data.forEach(img => {
            const cardCol = document.createElement('div');
            cardCol.classList.add('col');
            cardCol.innerHTML = `
                            <div class="card">
                              <img class="card-img-top" src=${img.url} alt="">
                            </div>
                          `;
            cardRow.appendChild(cardCol);

            newDestination.Links += img.url + ';';
          });
        })
        .catch((error) => {
          console.error('Error:', error);
        });
    }

    function uploadHotels(index) {
      const files = document.getElementById(`formMultiFile-hotel-${index}`).files;
      const formData = new FormData();
      for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
      }
      fetch(apiUpload + '/multi', {
        method: 'POST',
        body: formData,
      })
        .then(response => response.json())
        .then(data => {
          console.log('Success:', data);
          const hotelRow = document.getElementById(`hotel-list-img-${index}`);
          // clear old data
          hotelRow.innerHTML = '';
          data.forEach(img => {
            const hotelCol = document.createElement('div');
            hotelCol.classList.add('col');
            hotelCol.innerHTML = `
                            <div class="card">
                              <img class="card-img-top" src=${img.url} alt="">
                            </div>
                          `;
            hotelRow.appendChild(hotelCol);
          });
        })
        .catch((error) => {
          console.error('Error:', error);
        });
    }

    function addHotelSection(index) {
      const hotelList = document.getElementById('hotel-list');
      const hotelRow = document.createElement('div');
      hotelRow.classList.add('row');
      hotelRow.innerHTML = `
        <div class="col-sm-7 pt-3">
          <textarea rows="5" cols="55" id="editor-${index}" class="form-control" placeholder="Hotel ${index} description" aria-label="Hotel description"></textarea>
        </div>
        <div class="col-sm-5 pt-1">
          <div class="row">
            <div class="fileUpload col-sm-6" style="margin-left: 12px;" >
              <input type="file" class="upload" id="formMultiFile-hotel-${index}" onchange="uploadHotels(${index})" multiple />
              <svg class="icon">
                <use xlink:href="../../vendors/@coreui/icons/svg/free.svg#cil-cloud-upload"></use>
              </svg>
            </div>
          </div>
          <div class="row row-cols-1 row-cols-md-2 g-4 pt-1" id="hotel-list-img-${index}">
            <!-- Hotels generate here -->
          </div>
        </div>
      `;
      hotelList.appendChild(hotelRow);

      ClassicEditor
        .create(document.querySelector(`#editor-${index}`), {
          removePlugins: ['CKFinderUploadAdapter', 'CKFinder', 'EasyImage', 'Image', 'ImageCaption', 'ImageStyle', 'ImageToolbar', 'ImageUpload', 'MediaEmbed'],
        })
        .then(editor => {
          CKEditorArray[`#editor-${index}`] = editor;
        })
        .catch(error => {
          console.error(error);
        });

      hotelSection++;
    }

    // add restaurant section
    function addRestaurantSection(index) {
      const resList = document.getElementById('restaurant-list');
      const resRow = document.createElement('div');
      resRow.classList.add('row');
      resRow.innerHTML = `
        <div class="col-sm-7 pt-3">
          <textarea rows="5" cols="55" id="editor-res-${index}" class="form-control" placeholder="Restaurant ${index} description" aria-label="Restaurant description"></textarea>
        </div>
        <div class="col-sm-5 pt-1">
          <div class="row">
            <div class="fileUpload col-sm-6" style="margin-left: 12px;" >
              <input type="file" class="upload" id="formMultiFile-restaurant-${index}" onchange="uploadRestaurant(${index})" multiple />
              <svg class="icon">
                <use xlink:href="../../vendors/@coreui/icons/svg/free.svg#cil-cloud-upload"></use>
              </svg>
            </div>
          </div>
          <div class="row row-cols-1 row-cols-md-2 g-4 pt-1" id="restaurant-list-img-${index}">
            <!-- restaurant generate here -->
          </div>
        </div>
      `;
      resList.appendChild(resRow);

      ClassicEditor
        .create(document.querySelector(`#editor-res-${index}`), {
          removePlugins: ['CKFinderUploadAdapter', 'CKFinder', 'EasyImage', 'Image', 'ImageCaption', 'ImageStyle', 'ImageToolbar', 'ImageUpload', 'MediaEmbed'],
        })
        .then(editor => {
          CKEditorArray[`#editor-res-${index}`] = editor;
        })
        .catch(error => {
          console.error(error);
        });

      restaurantSection++;
    }

    function uploadRestaurant(index) {
      const files = document.getElementById(`formMultiFile-restaurant-${index}`).files;
      const formData = new FormData();
      for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
      }
      fetch(apiUpload + '/multi', {
        method: 'POST',
        body: formData,
      })
        .then(response => response.json())
        .then(data => {
          console.log('Success:', data);
          const restaurantRow = document.getElementById(`restaurant-list-img-${index}`);
          // clear old data
          restaurantRow.innerHTML = '';
          data.forEach(img => {
            const restaurantCol = document.createElement('div');
            restaurantCol.classList.add('col');
            restaurantCol.innerHTML = `
                            <div class="card">
                              <img class="card-img-top" src=${img.url} alt="">
                            </div>
                          `;
            restaurantRow.appendChild(restaurantCol);
          });
        })
        .catch((error) => {
          console.error('Error:', error);
        });
    }

    // add tourist-attractions section addTouristAttractionsSection
    function addTouristAttractionsSection(index) {
      const tourList = document.getElementById('tourist-attractions-list');
      const tourRow = document.createElement('div');
      tourRow.classList.add('row');
      tourRow.innerHTML = `
        <div class="col-sm-7 pt-3">
          <textarea id="editor-tourist-attractions-${index}" class="form-control" placeholder="Tourist attractions ${index} description" aria-label="Tourist attractions description"></textarea>
        </div>
        <div class="col-sm-5 pt-1">
          <div class="row">
            <div class="fileUpload col-sm-6" style="margin-left: 12px;" >
              <input type="file" class="upload" id="formMultiFile-tourist-attractions-${index}" onchange="uploadTourist(${index})" multiple />
              <svg class="icon">
                <use xlink:href="../../vendors/@coreui/icons/svg/free.svg#cil-cloud-upload"></use>
              </svg>
            </div>
          </div>
          <div class="row row-cols-1 row-cols-md-2 g-4 pt-1" id="tourist-attractions-list-img-${index}">
            <!-- tourist-attractions generate here -->
          </div>
        </div>
      `;
      tourList.appendChild(tourRow);

      ClassicEditor
        .create(document.querySelector(`#editor-tourist-attractions-${index}`), {
          removePlugins: ['CKFinderUploadAdapter', 'CKFinder', 'EasyImage', 'Image', 'ImageCaption', 'ImageStyle', 'ImageToolbar', 'ImageUpload', 'MediaEmbed'],
        })
        .then(editor => {
          CKEditorArray[`#editor-tourist-attractions-${index}`] = editor;
        })
        .catch(error => {
          console.error(error);
        });

      touristAttractionsSection++;
    }

    function uploadTourist(index) {
      const files = document.getElementById(`formMultiFile-tourist-attractions-${index}`).files;
      const formData = new FormData();
      for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
      }
      fetch(apiUpload + '/multi', {
        method: 'POST',
        body: formData,
      })
        .then(response => response.json())
        .then(data => {
          console.log('Success:', data);
          const touristRow = document.getElementById(`tourist-attractions-list-img-${index}`);
          // clear old data
          touristRow.innerHTML = '';
          data.forEach(img => {
            const touristCol = document.createElement('div');
            touristCol.classList.add('col');
            touristCol.innerHTML = `
                            <div class="card">
                              <img class="card-img-top" src=${img.url} alt="">
                            </div>
                          `;
            touristRow.appendChild(touristCol);
          });
        })
        .catch((error) => {
          console.error('Error:', error);
        });
    }
  </script>
</body>

</html>